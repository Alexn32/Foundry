<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Foundry</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0a0a0f; color: white; font-family: system-ui; padding: 20px; }
    h1 { font-size: 28px; margin-bottom: 20px; }
    .box { background: #18181b; border: 1px solid #27272a; padding: 20px; border-radius: 12px; margin-bottom: 16px; }
    input { width: 100%; padding: 16px; background: #0a0a0f; border: 1px solid #3f3f46; color: white; border-radius: 10px; font-size: 16px; margin-bottom: 12px; }
    button { width: 100%; padding: 16px; background: #4f46e5; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; }
    button:disabled { background: #3f3f46; }
    .msg { padding: 16px; border-radius: 10px; margin-bottom: 16px; font-size: 14px; }
    .success { background: #064e3b; border: 1px solid #10b981; color: #10b981; }
    .error { background: #7f1d1d; border: 1px solid #ef4444; color: #ef4444; }
    .pending { background: #292524; border: 1px solid #f59e0b; padding: 16px; border-radius: 10px; margin-bottom: 12px; }
    .competitor { background: #18181b; border: 1px solid #27272a; padding: 16px; border-radius: 10px; margin-bottom: 8px; }
  </style>
</head>
<body>
  <h1>ðŸŽ¯ Foundry</h1>
  <div id="status"></div>
  
  <div class="box">
    <input id="product" type="text" placeholder="What are you building? (e.g., CRM for dentists)">
    <button id="btn" onclick="startDiscovery()">Discover Competitors</button>
  </div>
  
  <div id="pendings"></div>
  <div id="results"></div>

  <script>
    const API = 'https://foundry-production-7b5f.up.railway.app';
    let myTasks = [];
    let myCompetitors = [];

    function showStatus(text, isError) {
      const el = document.getElementById('status');
      el.innerHTML = '<div class="msg ' + (isError ? 'error' : 'success') + '">' + text + '</div>';
    }

    async function startDiscovery() {
      const input = document.getElementById('product');
      const btn = document.getElementById('btn');
      
      if (!input.value.trim()) {
        showStatus('Please enter a product description', true);
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'Sending...';
      showStatus('Sending request...');
      
      try {
        const response = await fetch(API + '/api/workspaces/demo/competitors/discover', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productDescription: input.value.trim() })
        });
        
        const data = await response.json();
        console.log('Response:', data);
        
        if (data.taskId) {
          showStatus('âœ… Created! Tap "Approve" below');
          input.value = '';
          loadData();
        } else {
          showStatus('âŒ Failed: ' + JSON.stringify(data), true);
        }
      } catch (err) {
        console.error(err);
        showStatus('âŒ Error: ' + err.message, true);
      }
      
      btn.disabled = false;
      btn.textContent = 'Discover Competitors';
    }

    async function approveTask(taskId) {
      const btn = document.getElementById('btn-' + taskId);
      btn.disabled = true;
      btn.textContent = 'Running...';
      
      try {
        const response = await fetch(API + '/api/tasks/' + taskId + '/approve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: 'founder-1' })
        });
        
        const data = await response.json();
        console.log('Approve response:', data);
        
        if (data.success) {
          showStatus('âœ… Found ' + data.competitorsFound + ' competitors!');
          myCompetitors = data.competitors || [];
          render();
        } else {
          showStatus('âŒ Failed', true);
          btn.disabled = false;
          btn.textContent = 'Approve & Run';
        }
      } catch (err) {
        showStatus('âŒ Error', true);
        btn.disabled = false;
        btn.textContent = 'Approve & Run';
      }
    }

    async function loadData() {
      try {
        const response = await fetch(API + '/api/workspaces/demo');
        const data = await response.json();
        myTasks = data.tasks || [];
        myCompetitors = data.competitors || [];
        render();
      } catch (err) {
        console.error('Load error:', err);
      }
    }

    function render() {
      // Show pending tasks
      const pending = myTasks.filter(t => t.status === 'pending' && t.requiresApproval);
      let pendingHtml = '';
      
      if (pending.length > 0) {
        pendingHtml = '<h3 style="color:#f59e0b;margin:20px 0 12px;">Pending Approval</h3>';
        pending.forEach(t => {
          pendingHtml += '<div class="pending">' +
            '<p style="margin-bottom:12px;">' + t.approvalPrompt + '</p>' +
            '<button id="btn-' + t.id + '" onclick="approveTask(\'' + t.id + '\')" style="background:#059669;">Approve & Run</button>' +
          '</div>';
        });
      }
      document.getElementById('pendings').innerHTML = pendingHtml;
      
      // Show competitors
      let compHtml = '';
      if (myCompetitors.length > 0) {
        compHtml = '<h3 style="color:#10b981;margin:20px 0 12px;">Competitors (' + myCompetitors.length + ')</h3>';
        myCompetitors.forEach(c => {
          compHtml += '<div class="competitor">' +
            '<div style="font-weight:600;margin-bottom:4px;">' + c.name + '</div>' +
            '<a href="' + c.website + '" target="_blank" style="color:#6b7280;font-size:14px;">' + c.website + '</a>' +
            '<span style="float:right;background:#3f3f46;padding:4px 12px;border-radius:4px;font-size:12px;">' + c.threatLevel + '</span>' +
          '</div>';
        });
      }
      document.getElementById('results').innerHTML = compHtml;
    }

    // Load on start and every 3 seconds
    loadData();
    setInterval(loadData, 3000);
  </script>
</body>
</html>
